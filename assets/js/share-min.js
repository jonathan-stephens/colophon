const CONFIG={API_ENDPOINTS:{ADD_BOOKMARK:"/api/bookmarks/add",FETCH_METADATA:"/api/bookmarks/fetch-metadata",TAGS:"/api/bookmarks/tags"},TAGS:{READ_LATER:"To Read",MIN_AUTOCOMPLETE_LENGTH:2,MAX_SUGGESTIONS:5},TIMEOUTS:{MESSAGE_DISPLAY:5e3,AUTO_FETCH_DELAY:300,DEBOUNCE_DELAY:300},DB:{NAME:"BookmarksOfflineDB",VERSION:1,STORE_NAME:"pendingBookmarks"}},AppState={credentials:null,tags:[],selectedSuggestionIndex:0,isOnline:navigator.onLine,db:null,elements:{}};function debounce(e,t){let n;return function(...s){clearTimeout(n),n=setTimeout((()=>e(...s)),t)}}function showMessage(e,t="info"){AppState.elements.messageDiv?(AppState.elements.messageDiv.textContent=e,AppState.elements.messageDiv.className="message "+t,AppState.elements.messageDiv.style.display="block",setTimeout((()=>{AppState.elements.messageDiv.style.display="none"}),CONFIG.TIMEOUTS.MESSAGE_DISPLAY)):console.error("Message element not found")}function extractDomain(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch(e){return console.error("Error extracting domain:",e),""}}function generateSlug(e){try{const t=new URL(e),n=t.pathname;if(n&&"/"!==n){const e=n.split("/").filter((e=>e));let t=e[e.length-1];if(t=t.replace(/\.(html|htm|php|asp|aspx)$/i,""),t)return t}const s=t.hostname.replace(/^www\./,"").split(".");return s.pop(),s.join("-")}catch(e){return console.error("Error generating slug:",e),""}}async function initDB(){return new Promise(((e,t)=>{const n=indexedDB.open(CONFIG.DB.NAME,CONFIG.DB.VERSION);n.onerror=()=>t(n.error),n.onsuccess=()=>{AppState.db=n.result,e(AppState.db)},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(CONFIG.DB.STORE_NAME)||t.createObjectStore(CONFIG.DB.STORE_NAME,{keyPath:"id",autoIncrement:!0})}}))}async function saveToOfflineQueue(e){return AppState.db||await initDB(),new Promise(((t,n)=>{const s=AppState.db.transaction([CONFIG.DB.STORE_NAME],"readwrite").objectStore(CONFIG.DB.STORE_NAME),a={...e,timestamp:Date.now(),synced:!1},o=s.add(a);o.onsuccess=()=>{console.log("ğŸ“¦ Saved to offline queue:",a),t(o.result)},o.onerror=()=>n(o.error)}))}async function getPendingBookmarks(){return AppState.db||await initDB(),new Promise(((e,t)=>{const n=AppState.db.transaction([CONFIG.DB.STORE_NAME],"readonly").objectStore(CONFIG.DB.STORE_NAME).getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}))}async function removeFromQueue(e){return AppState.db||await initDB(),new Promise(((t,n)=>{const s=AppState.db.transaction([CONFIG.DB.STORE_NAME],"readwrite").objectStore(CONFIG.DB.STORE_NAME).delete(e);s.onsuccess=()=>t(),s.onerror=()=>n(s.error)}))}async function syncOfflineBookmarks(){if(!navigator.onLine)return void console.log("ğŸ“¡ Still offline, sync postponed");const e=await getPendingBookmarks();if(0!==e.length){console.log(`ğŸ“¤ Syncing ${e.length} offline bookmarks...`);for(const t of e)try{const e=await getAuthCredentials();if(!e)continue;const n=await fetch(CONFIG.API_ENDPOINTS.ADD_BOOKMARK,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(e.email+":"+e.password)},body:JSON.stringify(t)}),s=await n.json();"success"===s.status?(await removeFromQueue(t.id),console.log("âœ… Synced:",t.title)):console.error("âŒ Sync failed:",s.message)}catch(e){console.error("âŒ Sync error:",e)}showMessage("âœ… Offline bookmarks synced!","success")}else console.log("âœ… No pending bookmarks to sync")}function normalizeTags(e){if(!e)return"";return e.split(",").map((e=>e.trim())).filter((e=>e)).map((e=>AppState.tags.find((t=>t.toLowerCase()===e.toLowerCase()))||e)).join(", ")}async function loadExistingTags(){try{const e=await fetch(CONFIG.API_ENDPOINTS.TAGS),t=await e.json();"success"===t.status&&t.data&&(AppState.tags=t.data,console.log("ğŸ“‹ Loaded",AppState.tags.length,"existing tags"))}catch(e){console.error("Failed to load tags:",e)}}function getTagSuggestions(e){if(!e||e.length<CONFIG.TAGS.MIN_AUTOCOMPLETE_LENGTH)return[];const t=e.toLowerCase();return AppState.tags.filter((e=>e.toLowerCase().includes(t))).slice(0,CONFIG.TAGS.MAX_SUGGESTIONS)}function showTagSuggestions(e,t){const n=AppState.elements.tagSuggestionsContainer;0!==t.length?(n.innerHTML="",n.classList.add("active"),t.forEach(((t,s)=>{const a=document.createElement("div");a.className="tag-suggestion",0===s&&a.classList.add("selected");const o=new RegExp(`(${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");a.innerHTML=t.replace(o,"<mark>$1</mark>"),a.addEventListener("click",(()=>{insertTag(t),n.classList.remove("active")})),n.appendChild(a)}))):n.classList.remove("active")}function insertTag(e){const t=AppState.elements.tagsInput,n=t.value.trim();let s=n?n.split(",").map((e=>e.trim())):[];s.pop(),s.push(e),t.value=s.join(", ")+", ",t.focus()}function updateSelection(e,t){e.forEach(((e,n)=>{e.classList.toggle("selected",n===t)}))}const handleTagInput=debounce((e=>{const t=e.target.value.split(","),n=t[t.length-1].trim();if(n.length>=CONFIG.TAGS.MIN_AUTOCOMPLETE_LENGTH){showTagSuggestions(n,getTagSuggestions(n)),AppState.selectedSuggestionIndex=0}else AppState.elements.tagSuggestionsContainer.classList.remove("active")}),CONFIG.TIMEOUTS.DEBOUNCE_DELAY);async function fetchMetadata(e){if(e){showMessage("Fetching metadata...","info"),console.log("ğŸ“¡ Fetching metadata for:",e);try{const t=await fetch(CONFIG.API_ENDPOINTS.FETCH_METADATA,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}),n=await t.json();if(console.log("Metadata response:",n),"success"===n.status&&n.data){const e=n.data;let t=[];e.author&&AppState.elements.authorInput&&!AppState.elements.authorInput.value&&(AppState.elements.authorInput.value=e.author,t.push("author"),console.log("âœ… Author set:",e.author)),e.tags&&AppState.elements.tagsInput&&!AppState.elements.tagsInput.value&&(AppState.elements.tagsInput.value=e.tags,t.push("tags"),console.log("âœ… Tags set:",e.tags)),e.title&&AppState.elements.titleInput&&!AppState.elements.titleInput.value&&(AppState.elements.titleInput.value=e.title,t.push("title"),console.log("âœ… Title set:",e.title)),t.length>0?showMessage(`Metadata fetched! Updated: ${t.join(", ")}`,"success"):showMessage("Metadata fetched (no empty fields to fill)","info")}else showMessage("Could not fetch metadata","info"),console.log("Metadata fetch returned no data")}catch(e){console.error("Metadata fetch error:",e),showMessage("Error fetching metadata: "+e.message,"error")}}}async function getAuthCredentials(){const e=document.body.dataset.userEmail;if(e){if(console.log("âœ… User logged in via session:",e),AppState.credentials&&AppState.credentials.email===e)return console.log("Using cached credentials"),AppState.credentials;const t=prompt(`Enter your Kirby password for: ${e}\n\n(This is your panel login password)`);return t?(AppState.credentials={email:e,password:t},AppState.credentials):null}if(console.log("âš ï¸ No session found - full login required"),AppState.credentials)return console.log("Using cached credentials from this session"),AppState.credentials;const t=prompt("Enter your Kirby email:\n(Your panel login email)");if(!t)return null;const n=prompt("Enter your Kirby password:\n(Your panel login password)");return n?(AppState.credentials={email:t,password:n},console.log("Stored credentials for this session:",t),AppState.credentials):null}function updateOnlineStatus(){navigator.onLine?(AppState.elements.offlineIndicator.classList.remove("show"),syncOfflineBookmarks()):AppState.elements.offlineIndicator.classList.add("show"),AppState.isOnline=navigator.onLine}async function handleFormSubmit(e){e.preventDefault(),console.log("Form submitted");const t=document.body.dataset.userEmail,n=normalizeTags(AppState.elements.tagsInput?AppState.elements.tagsInput.value:""),s={website:AppState.elements.websiteInput?AppState.elements.websiteInput.value:"",title:AppState.elements.titleInput?AppState.elements.titleInput.value:"",tld:AppState.elements.tldInput?AppState.elements.tldInput.value:"",slug:AppState.elements.slugInput?AppState.elements.slugInput.value:"",author:AppState.elements.authorInput?AppState.elements.authorInput.value:"",tags:n,text:AppState.elements.textInput?AppState.elements.textInput.value:""};if(console.log("Submitting bookmark:",s),!navigator.onLine){console.log("ğŸ“¡ Offline - saving to queue");try{return await saveToOfflineQueue(s),showMessage("ğŸ“¡ Saved offline! Will sync when you're back online.","success"),void AppState.elements.form.reset()}catch(e){return void showMessage("Error saving offline: "+e.message,"error")}}try{let e;if(t){console.log("Attempting save with session auth..."),e=await fetch(CONFIG.API_ENDPOINTS.ADD_BOOKMARK,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(s)});if("success"===(await e.json()).status)return console.log("âœ… Saved with session auth"),showMessage("Bookmark saved successfully!","success"),void setTimeout((()=>{window.location.href="/links"}),1500);console.log("Session auth failed, trying Basic auth...")}const n=await getAuthCredentials();if(!n||!n.password)return void showMessage("Authentication required","error");e=await fetch(CONFIG.API_ENDPOINTS.ADD_BOOKMARK,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(n.email+":"+n.password)},body:JSON.stringify(s)});const a=await e.json();console.log("Save response:",a),"success"===a.status?(showMessage("Bookmark saved successfully!","success"),setTimeout((()=>{window.location.href="/links"}),1500)):a.message&&a.message.includes("authentication")?(AppState.credentials=null,showMessage("Authentication failed. Please try again.","error")):showMessage(a.message||"Error saving bookmark","error")}catch(e){console.error("Network error:",e),showMessage("Network error: "+e.message,"error")}}async function handleQuickSave(){console.log("Quick save button clicked");const e=AppState.elements.websiteInput?AppState.elements.websiteInput.value.trim():"";if(e){if(AppState.elements.titleInput&&!AppState.elements.titleInput.value&&(AppState.elements.titleInput.value="Read Later"),AppState.elements.tldInput&&!AppState.elements.tldInput.value){const t=extractDomain(e);t&&(AppState.elements.tldInput.value=t)}if(AppState.elements.slugInput&&!AppState.elements.slugInput.value){const t=generateSlug(e);t&&(AppState.elements.slugInput.value=t)}if(AppState.elements.tagsInput){const e=AppState.elements.tagsInput.value.trim();if(e){e.split(",").map((e=>e.trim())).some((e=>e.toLowerCase()===CONFIG.TAGS.READ_LATER.toLowerCase()))||(AppState.elements.tagsInput.value=CONFIG.TAGS.READ_LATER+", "+e)}else AppState.elements.tagsInput.value=CONFIG.TAGS.READ_LATER}console.log("Quick saving - submitting form"),AppState.elements.form.dispatchEvent(new Event("submit"))}else showMessage("URL is required","error")}function setupKeyboardShortcuts(){document.addEventListener("keydown",(e=>{if((e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),console.log("âŒ¨ï¸ Keyboard shortcut: Save (Ctrl+S)"),AppState.elements.form&&AppState.elements.form.dispatchEvent(new Event("submit"))),(e.ctrlKey||e.metaKey)&&e.shiftKey&&"S"===e.key&&(e.preventDefault(),console.log("âŒ¨ï¸ Keyboard shortcut: Quick Save (Ctrl+Shift+S)"),AppState.elements.quickSaveBtn&&handleQuickSave()),(e.ctrlKey||e.metaKey)&&"m"===e.key){e.preventDefault(),console.log("âŒ¨ï¸ Keyboard shortcut: Fetch Metadata (Ctrl+M)");const t=AppState.elements.websiteInput?AppState.elements.websiteInput.value.trim():"";t?fetchMetadata(t):showMessage("Please enter a URL first","error")}"Escape"===e.key&&AppState.elements.tagSuggestionsContainer&&AppState.elements.tagSuggestionsContainer.classList.remove("active")})),console.log("âŒ¨ï¸ Keyboard shortcuts enabled:"),console.log("  â€¢ Ctrl/Cmd + S: Save bookmark"),console.log("  â€¢ Ctrl/Cmd + Shift + S: Quick Save"),console.log("  â€¢ Ctrl/Cmd + M: Fetch Metadata"),console.log("  â€¢ Escape: Close tag suggestions")}function setupEventListeners(){const{websiteInput:e,tagsInput:t,fetchMetadataBtn:n,quickSaveBtn:s,form:a,tagSuggestionsContainer:o}=AppState.elements;e&&e.addEventListener("blur",(()=>{const t=e.value.trim();if(!t)return;const n=extractDomain(t);n&&AppState.elements.tldInput&&!AppState.elements.tldInput.value&&(AppState.elements.tldInput.value=n,console.log("Domain extracted:",n));const s=generateSlug(t);s&&AppState.elements.slugInput&&!AppState.elements.slugInput.value&&(AppState.elements.slugInput.value=s,console.log("Slug generated:",s))})),t&&o&&(t.addEventListener("input",handleTagInput),t.addEventListener("keydown",(e=>{const t=o.querySelectorAll(".tag-suggestion");o.classList.contains("active")&&("ArrowDown"===e.key?(e.preventDefault(),AppState.selectedSuggestionIndex=(AppState.selectedSuggestionIndex+1)%t.length,updateSelection(t,AppState.selectedSuggestionIndex)):"ArrowUp"===e.key?(e.preventDefault(),AppState.selectedSuggestionIndex=(AppState.selectedSuggestionIndex-1+t.length)%t.length,updateSelection(t,AppState.selectedSuggestionIndex)):"Enter"===e.key&&t.length>0?(e.preventDefault(),t[AppState.selectedSuggestionIndex].click()):"Escape"===e.key&&o.classList.remove("active"))})),document.addEventListener("click",(e=>{t.contains(e.target)||o.contains(e.target)||o.classList.remove("active")}))),n&&n.addEventListener("click",(()=>{console.log("Fetch metadata button clicked");const t=e?e.value.trim():"";t?fetchMetadata(t):showMessage("Please enter a URL first","error")})),s&&s.addEventListener("click",handleQuickSave),a&&a.addEventListener("submit",handleFormSubmit),window.addEventListener("online",updateOnlineStatus),window.addEventListener("offline",updateOnlineStatus),console.log("âœ… All event listeners attached successfully")}window.addEventListener("DOMContentLoaded",(async()=>{console.log("âœ… share.js loaded"),AppState.elements={websiteInput:document.getElementById("website"),tldInput:document.getElementById("tld"),slugInput:document.getElementById("slug"),authorInput:document.getElementById("author"),tagsInput:document.getElementById("tags"),titleInput:document.getElementById("page-title"),textInput:document.getElementById("text"),form:document.getElementById("bookmark-form"),fetchMetadataBtn:document.getElementById("fetch-metadata-btn"),quickSaveBtn:document.getElementById("quick-save-btn"),messageDiv:document.getElementById("message"),offlineIndicator:document.getElementById("offline-indicator"),tagSuggestionsContainer:document.getElementById("tag-suggestions")},console.log("Element check:",{websiteInput:!!AppState.elements.websiteInput,tldInput:!!AppState.elements.tldInput,slugInput:!!AppState.elements.slugInput,authorInput:!!AppState.elements.authorInput,tagsInput:!!AppState.elements.tagsInput,titleInput:!!AppState.elements.titleInput,textInput:!!AppState.elements.textInput,form:!!AppState.elements.form,fetchBtn:!!AppState.elements.fetchMetadataBtn,quickSaveBtn:!!AppState.elements.quickSaveBtn,messageDiv:!!AppState.elements.messageDiv,tagSuggestions:!!AppState.elements.tagSuggestionsContainer});const e=document.getElementById("js-test");e&&(e.textContent="âœ… JavaScript loaded and working!",e.style.background="#d4edda",e.style.color="#155724"),await initDB(),await loadExistingTags(),setupEventListeners(),setupKeyboardShortcuts(),updateOnlineStatus(),setTimeout((()=>{AppState.elements.websiteInput&&AppState.elements.websiteInput.value?(console.log("ğŸŒ Prefilled URL detected:",AppState.elements.websiteInput.value),AppState.elements.websiteInput.dispatchEvent(new Event("blur")),console.log("ğŸ”„ Auto-fetching metadata for shared URL..."),fetchMetadata(AppState.elements.websiteInput.value)):console.log("â„¹ï¸ No prefilled URL found.")}),CONFIG.TIMEOUTS.AUTO_FETCH_DELAY),console.log("ğŸ‰ Application initialized successfully")}));