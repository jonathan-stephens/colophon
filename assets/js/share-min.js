window.addEventListener("DOMContentLoaded",(()=>{console.log("✅ share.js loaded");const e=document.getElementById("js-test");e&&(e.textContent="✅ JavaScript loaded and working!",e.style.background="#d4edda",e.style.color="#155724");const t=document.getElementById("website"),o=document.getElementById("tld"),a=document.getElementById("author"),s=document.getElementById("tags"),r=document.getElementById("page-title"),n=document.getElementById("text"),l=document.getElementById("bookmark-form"),i=document.getElementById("fetch-metadata-btn"),c=document.getElementById("quick-save-btn"),d=document.getElementById("message");function u(e,t="info"){d?(d.textContent=e,d.className="message "+t,d.style.display="block",setTimeout((()=>d.style.display="none"),5e3)):console.error("Message element not found")}async function m(e){if(e){u("Fetching metadata...","info");try{const t=await fetch("/api/bookmarks/fetch-metadata",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}),o=await t.json();if(console.log("Metadata response:",o),"success"===o.status&&o.data){const e=o.data;e.author&&a&&!a.value&&(a.value=e.author),e.tags&&s&&!s.value&&(s.value=e.tags),e.title&&r&&!r.value&&(r.value=e.title),u("Metadata fetched successfully!","success")}else u("Could not fetch metadata","info")}catch(e){console.error("Metadata fetch error:",e),u("Error fetching metadata: "+e.message,"error")}}}console.log("Element check:",{websiteInput:!!t,tldInput:!!o,authorInput:!!a,tagsInput:!!s,titleInput:!!r,textInput:!!n,form:!!l,fetchBtn:!!i,quickSaveBtn:!!c,messageEl:!!d}),t&&t.addEventListener("blur",(()=>{const e=t.value.trim();if(!e)return;const a=function(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch(e){return console.error("Error extracting domain:",e),""}}(e);a&&o&&(o.value=a,console.log("Domain extracted:",a))})),i&&i.addEventListener("click",(()=>{console.log("Fetch metadata button clicked");const e=t?t.value.trim():"";e?m(e):u("Please enter a URL first","error")})),setTimeout((()=>{t&&t.value?(console.log("🌐 Prefilled URL detected:",t.value),t.dispatchEvent(new Event("blur")),m(t.value)):console.log("ℹ️ No prefilled URL found.")}),300),l&&l.addEventListener("submit",(async e=>{e.preventDefault(),console.log("Form submitted");const i=await async function(){const e=document.body.dataset.userEmail||null;if(e){let t=localStorage.getItem("kirby_api_password");if(!t){if(t=prompt("Enter your Kirby password for API access:\n(This is your panel login password)"),!t)return null;localStorage.setItem("kirby_api_password",t)}return console.log("Using stored auth for:",e),{email:e,password:t}}let t=localStorage.getItem("kirby_api_email"),o=localStorage.getItem("kirby_api_password");if(!t||!o){const e=prompt("Enter your Kirby email:\n(Your panel login email)");if(!e)return null;const t=prompt("Enter your Kirby password:\n(Your panel login password)");return t?(localStorage.setItem("kirby_api_email",e),localStorage.setItem("kirby_api_password",t),console.log("Stored new credentials for:",e),{email:e,password:t}):null}return console.log("Using stored credentials for:",t),{email:t,password:o}}();if(!i||!i.password)return void u("Authentication required","error");const c={website:t?t.value:"",title:r?r.value:"",tld:o?o.value:"",author:a?a.value:"",tags:s?s.value:"",text:n?n.value:""};console.log("Submitting bookmark:",c);try{const e=await fetch("/api/bookmarks/add",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(i.email+":"+i.password)},body:JSON.stringify(c)}),t=await e.json();console.log("Save response:",t),"success"===t.status?(u("Bookmark saved successfully!","success"),l.reset()):t.message&&t.message.includes("authentication")?(localStorage.removeItem("kirby_api_password"),u("Authentication failed. Please try again.","error")):u(t.message||"Error saving bookmark","error")}catch(e){console.error("Network error:",e),u("Network error: "+e.message,"error")}})),c&&c.addEventListener("click",(async()=>{console.log("Quick save button clicked");const e=t?t.value.trim():"",o=r?r.value.trim():"";if(e){console.log("Quick saving:",{url:e,title:o});try{const t=await fetch("/api/bookmarks/quick-add",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({url:e,title:o,text:""})}),a=await t.json();console.log("Quick save response:",a),"success"===a.status?(u("Quickly saved!","success"),l.reset()):u(a.message||"Error saving bookmark","error")}catch(e){console.error("Network error:",e),u("Network error: "+e.message,"error")}}else u("URL is required","error")})),console.log("🎉 All event listeners attached successfully")}));