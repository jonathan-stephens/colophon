const DB_NAME="BookmarksOfflineDB",DB_VERSION=1,STORE_NAME="pendingBookmarks";let db;async function initDB(){return new Promise(((e,t)=>{const o=indexedDB.open(DB_NAME,1);o.onerror=()=>t(o.error),o.onsuccess=()=>{db=o.result,e(db)},o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(STORE_NAME)||t.createObjectStore(STORE_NAME,{keyPath:"id",autoIncrement:!0})}}))}async function saveToOfflineQueue(e){return db||await initDB(),new Promise(((t,o)=>{const n=db.transaction([STORE_NAME],"readwrite").objectStore(STORE_NAME),s={...e,timestamp:Date.now(),synced:!1},a=n.add(s);a.onsuccess=()=>{console.log("ðŸ“¦ Saved to offline queue:",s),t(a.result)},a.onerror=()=>o(a.error)}))}async function getPendingBookmarks(){return db||await initDB(),new Promise(((e,t)=>{const o=db.transaction([STORE_NAME],"readonly").objectStore(STORE_NAME).getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}))}async function removeFromQueue(e){return db||await initDB(),new Promise(((t,o)=>{const n=db.transaction([STORE_NAME],"readwrite").objectStore(STORE_NAME).delete(e);n.onsuccess=()=>t(),n.onerror=()=>o(n.error)}))}async function syncOfflineBookmarks(){if(!navigator.onLine)return void console.log("ðŸ“¡ Still offline, sync postponed");const e=await getPendingBookmarks();if(0!==e.length){console.log(`ðŸ“¤ Syncing ${e.length} offline bookmarks...`);for(const t of e)try{const e=await getAuthCredentials();if(!e)continue;const o=await fetch("/api/bookmarks/add",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(e.email+":"+e.password)},body:JSON.stringify(t)}),n=await o.json();"success"===n.status?(await removeFromQueue(t.id),console.log("âœ… Synced:",t.title)):console.error("âŒ Sync failed:",n.message)}catch(e){console.error("âŒ Sync error:",e)}showMessage("âœ… Offline bookmarks synced!","success")}else console.log("âœ… No pending bookmarks to sync")}let allTags=[];async function loadExistingTags(){try{const e=await fetch("/api/bookmarks/tags"),t=await e.json();"success"===t.status&&t.data&&(allTags=t.data,console.log("ðŸ“‹ Loaded",allTags.length,"existing tags"))}catch(e){console.error("Failed to load tags:",e)}}function showTagSuggestions(e,t){const o=document.getElementById("tag-suggestions");0!==t.length?(o.innerHTML="",o.classList.add("active"),t.forEach(((t,n)=>{const s=document.createElement("div");s.className="tag-suggestion",0===n&&s.classList.add("selected");const a=new RegExp(`(${e})`,"gi");s.innerHTML=t.replace(a,"<mark>$1</mark>"),s.addEventListener("click",(()=>{insertTag(t),o.classList.remove("active")})),o.appendChild(s)}))):o.classList.remove("active")}function insertTag(e){const t=document.getElementById("tags"),o=t.value.trim();let n=o?o.split(",").map((e=>e.trim())):[];n.pop(),n.push(e),t.value=n.join(", ")+", ",t.focus()}function getTagSuggestions(e){if(!e||e.length<2)return[];const t=e.toLowerCase();return allTags.filter((e=>e.toLowerCase().includes(t))).slice(0,5)}window.addEventListener("DOMContentLoaded",(async()=>{console.log("âœ… share.js loaded"),await initDB(),await loadExistingTags();const e=document.getElementById("website"),t=document.getElementById("tld"),o=document.getElementById("slug"),n=document.getElementById("author"),s=document.getElementById("tags"),a=document.getElementById("page-title"),r=document.getElementById("text"),i=document.getElementById("bookmark-form"),l=document.getElementById("fetch-metadata-btn"),c=document.getElementById("quick-save-btn"),d=document.getElementById("message"),u=document.getElementById("offline-indicator");console.log("Element check:",{websiteInput:!!e,tldInput:!!t,slugInput:!!o,authorInput:!!n,tagsInput:!!s,titleInput:!!a,textInput:!!r,form:!!i,fetchBtn:!!l,quickSaveBtn:!!c,messageDiv:!!d});const g=document.getElementById("js-test");g&&(g.textContent="âœ… JavaScript loaded and working!",g.style.background="#d4edda",g.style.color="#155724");let m=null;function f(){navigator.onLine?(u.classList.remove("show"),syncOfflineBookmarks()):u.classList.add("show")}if(window.addEventListener("online",f),window.addEventListener("offline",f),f(),s){let e=0;const t=document.getElementById("tag-suggestions");s.addEventListener("input",(o=>{const n=o.target.value.split(","),s=n[n.length-1].trim();if(s.length>=2){showTagSuggestions(s,getTagSuggestions(s)),e=0}else t.classList.remove("active")})),s.addEventListener("keydown",(o=>{const n=t.querySelectorAll(".tag-suggestion");t.classList.contains("active")&&("ArrowDown"===o.key?(o.preventDefault(),e=(e+1)%n.length,h(n,e)):"ArrowUp"===o.key?(o.preventDefault(),e=(e-1+n.length)%n.length,h(n,e)):"Enter"===o.key&&n.length>0?(o.preventDefault(),n[e].click()):"Escape"===o.key&&t.classList.remove("active"))})),document.addEventListener("click",(e=>{s.contains(e.target)||t.contains(e.target)||t.classList.remove("active")}))}function h(e,t){e.forEach(((e,o)=>{e.classList.toggle("selected",o===t)}))}function v(e,t="info"){d?(d.textContent=e,d.className="message "+t,d.style.display="block",setTimeout((()=>{d.style.display="none"}),5e3)):console.error("Message element not found")}function p(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch(e){return console.error("Error extracting domain:",e),""}}function y(e){try{const t=new URL(e),o=t.pathname;if(o&&"/"!==o){const e=o.split("/").filter((e=>e));let t=e[e.length-1];if(t=t.replace(/\.(html|htm|php|asp|aspx)$/i,""),t)return t}const n=t.hostname.replace(/^www\./,"").split(".");return n.pop(),n.join("-")}catch(e){return console.error("Error generating slug:",e),""}}async function w(e){if(e){v("Fetching metadata...","info"),console.log("ðŸ“¡ Fetching metadata for:",e);try{const t=await fetch("/api/bookmarks/fetch-metadata",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}),o=await t.json();if(console.log("Metadata response:",o),"success"===o.status&&o.data){const e=o.data;let t=[];e.author&&n&&!n.value&&(n.value=e.author,t.push("author"),console.log("âœ… Author set:",e.author)),e.tags&&s&&!s.value&&(s.value=e.tags,t.push("tags"),console.log("âœ… Tags set:",e.tags)),e.title&&a&&!a.value&&(a.value=e.title,t.push("title"),console.log("âœ… Title set:",e.title)),t.length>0?v(`Metadata fetched! Updated: ${t.join(", ")}`,"success"):v("Metadata fetched (no empty fields to fill)","info")}else v("Could not fetch metadata","info"),console.log("Metadata fetch returned no data")}catch(e){console.error("Metadata fetch error:",e),v("Error fetching metadata: "+e.message,"error")}}}async function E(){const e=document.body.dataset.userEmail;if(e){if(console.log("âœ… User logged in via session:",e),m&&m.email===e)return console.log("Using cached credentials"),m;const t=prompt(`Enter your Kirby password for: ${e}\n\n(This is your panel login password)`);return t?(m={email:e,password:t},m):null}if(console.log("âš ï¸ No session found - full login required"),m)return console.log("Using cached credentials from this session"),m;const t=prompt("Enter your Kirby email:\n(Your panel login email)");if(!t)return null;const o=prompt("Enter your Kirby password:\n(Your panel login password)");return o?(m={email:t,password:o},console.log("Stored credentials for this session:",t),m):null}window.showMessage=v,e&&e.addEventListener("blur",(()=>{const n=e.value.trim();if(!n)return;const s=p(n);s&&t&&!t.value&&(t.value=s,console.log("Domain extracted:",s));const a=y(n);a&&o&&!o.value&&(o.value=a,console.log("Slug generated:",a))})),l&&l.addEventListener("click",(()=>{console.log("Fetch metadata button clicked");const t=e?e.value.trim():"";t?w(t):v("Please enter a URL first","error")})),setTimeout((()=>{e&&e.value?(console.log("ðŸŒ Prefilled URL detected:",e.value),e.dispatchEvent(new Event("blur")),console.log("ðŸ”„ Auto-fetching metadata for shared URL..."),w(e.value)):console.log("â„¹ï¸ No prefilled URL found.")}),300),window.getAuthCredentials=E,i&&i.addEventListener("submit",(async l=>{l.preventDefault(),console.log("Form submitted");const c=document.body.dataset.userEmail,d={website:e?e.value:"",title:a?a.value:"",tld:t?t.value:"",slug:o?o.value:"",author:n?n.value:"",tags:s?s.value:"",text:r?r.value:""};if(console.log("Submitting bookmark:",d),!navigator.onLine){console.log("ðŸ“¡ Offline - saving to queue");try{return await saveToOfflineQueue(d),v("ðŸ“¡ Saved offline! Will sync when you're back online.","success"),void i.reset()}catch(e){return void v("Error saving offline: "+e.message,"error")}}try{let e;if(c){console.log("Attempting save with session auth..."),e=await fetch("/api/bookmarks/add",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(d)});if("success"===(await e.json()).status)return console.log("âœ… Saved with session auth"),v("Bookmark saved successfully!","success"),void setTimeout((()=>{window.location.href="/links"}),1500);console.log("Session auth failed, trying Basic auth...")}const t=await E();if(!t||!t.password)return void v("Authentication required","error");e=await fetch("/api/bookmarks/add",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(t.email+":"+t.password)},body:JSON.stringify(d)});const o=await e.json();console.log("Save response:",o),"success"===o.status?(v("Bookmark saved successfully!","success"),setTimeout((()=>{window.location.href="/links"}),1500)):o.message&&o.message.includes("authentication")?(m=null,v("Authentication failed. Please try again.","error")):v(o.message||"Error saving bookmark","error")}catch(e){console.error("Network error:",e),v("Network error: "+e.message,"error")}})),c&&c.addEventListener("click",(async()=>{console.log("Quick save button clicked");const n=e?e.value.trim():"";if(n){if(a&&!a.value&&(a.value="Read Later"),t&&!t.value){const e=p(n);e&&(t.value=e)}if(o&&!o.value){const e=y(n);e&&(o.value=e)}s&&!s.value&&(s.value="Read-Later"),console.log("Quick saving - submitting form"),i.dispatchEvent(new Event("submit"))}else v("URL is required","error")})),console.log("ðŸŽ‰ All event listeners attached successfully")}));