window.addEventListener("DOMContentLoaded",(()=>{console.log("âœ… share.js loaded");const e=document.getElementById("js-test");e&&(e.textContent="âœ… JavaScript loaded and working!",e.style.background="#d4edda",e.style.color="#155724");const t=document.getElementById("website"),o=document.getElementById("tld"),a=document.getElementById("author"),r=document.getElementById("tags"),s=document.getElementById("page-title"),n=document.getElementById("text"),l=document.getElementById("bookmark-form"),c=document.getElementById("fetch-metadata-btn"),i=document.getElementById("quick-save-btn"),u=document.getElementById("message");console.log("Element check:",{websiteInput:!!t,tldInput:!!o,authorInput:!!a,tagsInput:!!r,titleInput:!!s,textInput:!!n,form:!!l,fetchBtn:!!c,quickSaveBtn:!!i,messageEl:!!u});const d=new URLSearchParams(window.location.search),m=d.get("url"),g=d.get("title"),p=d.get("text");if(console.log("ðŸ” URL Parameters detected:",{url:m,title:g,text:p,fullSearch:window.location.search}),m&&t&&!t.value){console.log("ðŸ“ Populating from URL parameters"),t.value=m,g&&s&&!s.value&&(s.value=g),p&&n&&!n.value&&(n.value=p);const e=f(m);e&&o&&(o.value=e,console.log("Domain extracted from URL param:",e))}function y(e,t="info"){u?(u.textContent=e,u.className="message "+t,u.style.display="block",setTimeout((()=>u.style.display="none"),5e3)):console.error("Message element not found")}function f(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch(e){return console.error("Error extracting domain:",e),""}}async function v(e){if(e){y("Fetching metadata...","info");try{const t=await fetch("/api/bookmarks/fetch-metadata",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}),o=await t.json();if(console.log("Metadata response:",o),"success"===o.status&&o.data){const e=o.data;e.author&&a&&!a.value&&(a.value=e.author),e.tags&&r&&!r.value&&(r.value=e.tags),e.title&&s&&!s.value&&(s.value=e.title),y("Metadata fetched successfully!","success")}else y("Could not fetch metadata","info")}catch(e){console.error("Metadata fetch error:",e),y("Error fetching metadata: "+e.message,"error")}}}t&&t.addEventListener("blur",(()=>{const e=t.value.trim();if(!e)return;const a=f(e);a&&o&&(o.value=a,console.log("Domain extracted:",a))})),c&&c.addEventListener("click",(()=>{console.log("Fetch metadata button clicked");const e=t?t.value.trim():"";e?v(e):y("Please enter a URL first","error")})),setTimeout((()=>{if(t&&t.value){console.log("ðŸŒ URL detected in form:",t.value),console.log("Source: "+(m?"URL parameter":"Server-side render"));!a.value||!s.value||!r.value?(console.log("ðŸ”„ Auto-fetching metadata..."),v(t.value)):console.log("â„¹ï¸ Form already populated, skipping auto-fetch")}else console.log("â„¹ï¸ No URL found in form.")}),500),l&&l.addEventListener("submit",(async e=>{e.preventDefault(),console.log("Form submitted");const c=await async function(){const e=document.body.dataset.userEmail||null;if(e){let t=localStorage.getItem("kirby_api_password");if(!t){if(t=prompt("Enter your Kirby password for API access:\n(This is your panel login password)"),!t)return null;localStorage.setItem("kirby_api_password",t)}return console.log("Using stored auth for:",e),{email:e,password:t}}let t=localStorage.getItem("kirby_api_email"),o=localStorage.getItem("kirby_api_password");if(!t||!o){const e=prompt("Enter your Kirby email:\n(Your panel login email)");if(!e)return null;const t=prompt("Enter your Kirby password:\n(Your panel login password)");return t?(localStorage.setItem("kirby_api_email",e),localStorage.setItem("kirby_api_password",t),console.log("Stored new credentials for:",e),{email:e,password:t}):null}return console.log("Using stored credentials for:",t),{email:t,password:o}}();if(!c||!c.password)return void y("Authentication required","error");const i={website:t?t.value:"",title:s?s.value:"",tld:o?o.value:"",author:a?a.value:"",tags:r?r.value:"",text:n?n.value:""};console.log("Submitting bookmark:",i);try{const e=await fetch("/api/bookmarks/add",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(c.email+":"+c.password)},body:JSON.stringify(i)}),t=await e.json();console.log("Save response:",t),"success"===t.status?(y("Bookmark saved successfully!","success"),l.reset()):t.message&&t.message.includes("authentication")?(localStorage.removeItem("kirby_api_password"),y("Authentication failed. Please try again.","error")):y(t.message||"Error saving bookmark","error")}catch(e){console.error("Network error:",e),y("Network error: "+e.message,"error")}})),i&&i.addEventListener("click",(async()=>{console.log("Quick save button clicked");const e=t?t.value.trim():"",o=s?s.value.trim():"";if(e){console.log("Quick saving:",{url:e,title:o});try{const t=await fetch("/api/bookmarks/quick-add",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({url:e,title:o,text:""})}),a=await t.json();console.log("Quick save response:",a),"success"===a.status?(y("Quickly saved!","success"),l.reset()):y(a.message||"Error saving bookmark","error")}catch(e){console.error("Network error:",e),y("Network error: "+e.message,"error")}}else y("URL is required","error")})),console.log("ðŸŽ‰ All event listeners attached successfully")}));