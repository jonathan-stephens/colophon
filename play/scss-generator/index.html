<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Color Palette Swatches</title>

  <!-- Add cache-busting timestamp to force reload -->
  <link rel="stylesheet" type="text/css" href="./src/styles/tokens-generated.css">

  <style>
    /* Styles for the swatch viewer */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Helvetica, Arial, sans-serif;
      background-color: oklch(98% 0.01 90);
      color: oklch(20% 0.01 90);
      padding: 2rem;
      margin: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid oklch(90% 0.01 90);
    }

    h1 {
      font-weight: 600;
      color: oklch(30% 0.01 90);
      margin: 0;
    }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .reload-btn {
      padding: 0.5rem 1rem;
      background: oklch(50% 0.15 260);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: "SF Mono", "Consolas", "Menlo", monospace;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .reload-btn:hover {
      background: oklch(45% 0.18 260);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px oklch(50% 0.15 260 / 0.3);
    }

    .reload-btn:active {
      transform: translateY(0);
    }

    .timestamp {
      font-family: "SF Mono", "Consolas", "Menlo", monospace;
      font-size: 0.75rem;
      color: oklch(60% 0.01 90);
    }

    #palette-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .palette-group {
      border: 1px solid oklch(90% 0.01 90);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px oklch(85% 0.02 90 / 0.5);
      transition: all 0.2s ease-in-out;
    }

    .palette-group:hover {
      box-shadow: 0 6px 16px oklch(80% 0.02 90 / 0.6);
    }

    .palette-title {
      background-color: oklch(95% 0.01 90);
      padding: 0.75rem 1rem;
      font-weight: 600;
      font-family: "SF Mono", "Consolas", "Menlo", monospace;
      font-size: 1.1em;
      border-bottom: 1px solid oklch(90% 0.01 90);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .palette-stats {
      font-size: 0.75rem;
      font-weight: 400;
      color: oklch(60% 0.01 90);
    }

    .swatch {
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: outline 0.1s ease-in-out;
      position: relative;
    }

    .swatch:not(:last-child) {
      border-bottom: 1px solid oklch(0% 0 0 / 0.05);
    }

    .swatch:hover {
      outline: 2px solid oklch(50% 0.2 260);
      outline-offset: -2px;
      z-index: 10;
    }

    .swatch-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .swatch-label,
    .swatch-value,
    .swatch-chroma {
      font-family: "SF Mono", "Consolas", "Menlo", monospace;
      font-size: 0.875rem;
    }

    .swatch-label {
      font-weight: 600;
    }

    .swatch-value {
      opacity: 0.7;
      font-size: 0.75rem;
    }

    .swatch-chroma {
      font-size: 0.7rem;
      opacity: 0.6;
      font-style: italic;
    }

    .swatch-label.copied {
      color: oklch(50% 0.2 120) !important;
      font-weight: 700;
    }

    .warning-badge {
      display: inline-block;
      padding: 0.125rem 0.375rem;
      background: oklch(70% 0.15 60);
      color: oklch(20% 0.05 60);
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: oklch(60% 0.01 90);
      font-family: "SF Mono", "Consolas", "Menlo", monospace;
    }

  </style>
</head>
<body>

  <div class="header">
    <h1>OKLCH Color Palette Viewer</h1>
    <div class="controls">
      <span class="timestamp" id="last-updated">Loading...</span>
      <button class="reload-btn" onclick="forceReload()">â†» Reload Colors</button>
    </div>
  </div>

  <main id="palette-container">
    <div class="loading">Loading color palettes...</div>
  </main>

  <script>
    let lastLoadTime = null;

    function forceReload() {
      // Force reload the CSS with cache busting
      const link = document.querySelector('link[href*="tokens-generated.css"]');
      const href = link.href.split('?')[0];
      link.href = href + '?t=' + new Date().getTime();

      // Wait a bit for CSS to load, then re-render
      setTimeout(() => {
        renderPalettes();
      }, 100);
    }

    function updateTimestamp() {
      const timestampEl = document.getElementById('last-updated');
      if (lastLoadTime) {
        timestampEl.textContent = `Updated: ${lastLoadTime.toLocaleTimeString()}`;
      }
    }

    function extractOklchValues(oklchString) {
      // Extract L, C, H from "oklch(15.0000% 0.0123 91.5200)"
      const match = oklchString.match(/oklch\(([\d.]+)%?\s+([\d.]+)\s+([\d.]+)\)/);
      if (match) {
        return {
          l: parseFloat(match[1]),
          c: parseFloat(match[2]),
          h: parseFloat(match[3])
        };
      }
      return null;
    }

    function renderPalettes() {
      const container = document.getElementById("palette-container");
      container.innerHTML = ''; // Clear existing content

      lastLoadTime = new Date();
      updateTimestamp();

      // Define the sort order for swatches
      const sortOrder = [
        "base",
        "darkest",
        "darker",
        "dark",
        "mid",
        "light",
        "lighter",
        "lightest",
      ];

      // Get all CSS variables from the :root stylesheet
      const allVars = {};
      try {
        const rootRule = Array.from(document.styleSheets)
          .flatMap((sheet) => {
            try {
              return Array.from(sheet.cssRules);
            } catch (e) {
              return []; // Skip stylesheets we can't access
            }
          })
          .find((rule) => rule.selectorText === ":root");

        if (rootRule) {
          const style = rootRule.style;
          for (let i = 0; i < style.length; i++) {
            const propName = style[i];
            if (propName.startsWith("--")) {
              const propValue = style.getPropertyValue(propName).trim();
              allVars[propName] = propValue;
            }
          }
        }
      } catch (e) {
        console.error("Could not parse stylesheets:", e);
        container.innerHTML = "<p class='loading'>Error: Could not read CSS variables.</p>";
        return;
      }

      if (Object.keys(allVars).length === 0) {
        container.innerHTML = "<p class='loading'>No color variables found. Run 'npm run build:colors' first.</p>";
        return;
      }

      // Group variables into palettes
      const palettes = {};
      for (const [propName, propValue] of Object.entries(allVars)) {
        const lastDashIndex = propName.lastIndexOf("-");
        if (lastDashIndex === -1) continue;

        const groupName = propName.substring(2, lastDashIndex);
        const variationName = propName.substring(lastDashIndex + 1);

        if (!sortOrder.includes(variationName)) continue;

        if (!palettes[groupName]) {
          palettes[groupName] = [];
        }

        palettes[groupName].push({
          name: propName,
          value: propValue,
          variation: variationName,
          oklch: extractOklchValues(propValue)
        });
      }

      // Sort and Render palettes
      const sortedPaletteNames = Object.keys(palettes).sort();

      for (const groupName of sortedPaletteNames) {
        const swatches = palettes[groupName];

        // Sort swatches by defined order
        swatches.sort((a, b) => {
          return sortOrder.indexOf(a.variation) - sortOrder.indexOf(b.variation);
        });

        // Calculate chroma range for this palette
        const chromas = swatches.map(s => s.oklch?.c || 0).filter(c => c > 0);
        const chromaRange = chromas.length > 0
          ? (Math.max(...chromas) - Math.min(...chromas)).toFixed(3)
          : '0';

        // Create HTML elements
        const groupEl = document.createElement("div");
        groupEl.className = "palette-group";

        const titleEl = document.createElement("div");
        titleEl.className = "palette-title";
        titleEl.innerHTML = `
          <span>${groupName}</span>
          <span class="palette-stats">Chroma range: ${chromaRange}</span>
        `;
        groupEl.appendChild(titleEl);

        const swatchesEl = document.createElement("div");
        swatchesEl.className = "swatches";

        for (const swatch of swatches) {
          const swatchEl = document.createElement("div");
          swatchEl.className = "swatch";

          // Apply the color
          swatchEl.style.backgroundColor = `var(${swatch.name})`;

          // Set text color based on lightness
          const lightness = swatch.oklch?.l || 50;
          swatchEl.style.color = lightness < 55 ? 'white' : 'black';

          const infoEl = document.createElement("div");
          infoEl.className = "swatch-info";

          const labelEl = document.createElement("span");
          labelEl.className = "swatch-label";
          labelEl.textContent = swatch.variation;

          const valueEl = document.createElement("span");
          valueEl.className = "swatch-value";
          valueEl.textContent = swatch.value;

          const chromaEl = document.createElement("span");
          chromaEl.className = "swatch-chroma";
          if (swatch.oklch) {
            chromaEl.textContent = `L: ${swatch.oklch.l.toFixed(1)}% C: ${swatch.oklch.c.toFixed(3)} H: ${swatch.oklch.h.toFixed(1)}Â°`;
          }

          infoEl.appendChild(labelEl);
          infoEl.appendChild(valueEl);
          infoEl.appendChild(chromaEl);

          swatchEl.appendChild(infoEl);

          // Add click-to-copy functionality
          swatchEl.title = `Click to copy ${swatch.name}`;
          swatchEl.onclick = () => {
            navigator.clipboard.writeText(swatch.name).then(() => {
              labelEl.textContent = 'Copied!';
              labelEl.classList.add('copied');
              setTimeout(() => {
                labelEl.textContent = swatch.variation;
                labelEl.classList.remove('copied');
              }, 1000);
            });
          };

          swatchesEl.appendChild(swatchEl);
        }

        groupEl.appendChild(swatchesEl);
        container.appendChild(groupEl);
      }
    }

    // Initial render when DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      // Small delay to ensure CSS is loaded
      setTimeout(renderPalettes, 50);
    });

    // Auto-reload detection: Check if CSS file was modified
    let checkInterval;
    function startAutoReload() {
      // Check every 2 seconds if in development
      checkInterval = setInterval(() => {
        fetch('./src/styles/tokens-generated.css', { method: 'HEAD' })
          .then(response => {
            const lastModified = response.headers.get('last-modified');
            if (lastModified) {
              const modifiedTime = new Date(lastModified);
              if (lastLoadTime && modifiedTime > lastLoadTime) {
                console.log('ðŸŽ¨ New colors detected, reloading...');
                forceReload();
              }
            }
          })
          .catch(() => {
            // Silently fail if can't check (e.g., file:// protocol)
          });
      }, 2000);
    }

    // Only enable auto-reload if we're on http:// or https://
    if (window.location.protocol.startsWith('http')) {
      startAutoReload();
    }
  </script>

</body>
</html>
