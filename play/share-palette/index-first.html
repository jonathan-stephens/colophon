<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Color Palette Tool</title>
    <style>
        /* CUBE CSS: Composition */
        .page-layout {
            display: grid;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            padding: 1rem;
        }
        
        .left-column {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 1rem;
        }
        
        .input-section {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 4px;
        }
        
        .stack > * + * {
            margin-block-start: 1rem;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            padding: 1rem;
        }
        
        /* CUBE CSS: Utilities */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* CUBE CSS: Blocks */
        .palette-display {
            border: 1px solid #ccc;
            background: #f9f9f9;
            overflow: auto;
            padding: 1rem;
            min-height: 300px;
        }
        
        .palette-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .controls {
            background: #f5f5f5;
            border-radius: 4px;
            overflow-y: auto;
            max-height: calc(100vh - 2rem);
        }
        
        .input-group > label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .input-group > input,
        .input-group > textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #999;
            border-radius: 2px;
        }
        
        .input-group > textarea {
            resize: vertical;
            min-height: 80px;
            font-family: monospace;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background: #005a8b;
        }
        
        .btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        
        .btn-help {
            background: #6c757d;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        .btn-help:hover {
            background: #495057;
        }
        
        .swatch-editor {
            border: 1px solid #ddd;
            padding: 0.75rem;
            background: white;
            border-radius: 2px;
            min-height: 200px;
        }
        
        .swatch-editor .input-group {
            margin-bottom: 0.5rem;
        }
        
        .swatch-editor .input-group:last-child {
            margin-bottom: 0;
        }
        
        .swatch-editor input {
            font-size: 0.8rem;
            padding: 0.25rem;
        }
        
        .color-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .color-preview {
            width: 32px;
            height: 32px;
            border: 1px solid #000;
            flex-shrink: 0;
            border-radius: 2px;
        }
        
        .color-info {
            font-size: 0.75rem;
            color: #666;
            font-family: monospace;
        }
        
        .category-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .category-input-wrapper input {
            margin-right: 0.5rem;
        }
        
        .tooltip-dialog {
            margin: 0;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
        }
        
        .tooltip-dialog::backdrop {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .tooltip-dialog h4 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        
        .tooltip-dialog ul {
            margin: 0;
            padding-left: 1.2rem;
            font-size: 0.9rem;
        }
        
        .tooltip-dialog button {
            margin-top: 0.5rem;
        }
        
        .footer {
            background: #f8f9fa;
            padding: 2rem;
            border-top: 1px solid #dee2e6;
        }
        
        .footer h3 {
            margin-top: 0;
        }
        
        .footer code {
            background: #e9ecef;
            padding: 0.125rem 0.25rem;
            border-radius: 2px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .footer pre {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.8rem;
        }
        
        /* Fix for sectioned h1 elements */
        h1 {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .controls-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .palette-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="page-layout">
    <main class="main-layout">
        <section class="left-column">
            <div class="input-section stack">
                <header>
                    <h1>SVG Color Palette Tool</h1>
                    <p>Upload or paste SVG color palettes, enhance with proper IDs and data attributes, then export or share.</p>
                </header>
                
                <div class="input-group">
                    <label for="file-input">Upload SVG File</label>
                    <input type="file" id="file-input" accept=".svg,image/svg+xml" aria-describedby="file-help">
                    <small id="file-help">Choose an SVG file containing color swatches</small>
                </div>
                
                <div class="input-group">
                    <label for="svg-input">Or Paste SVG Code</label>
                    <textarea id="svg-input" placeholder="Paste your SVG code here..." aria-describedby="svg-help"></textarea>
                    <small id="svg-help">Paste SVG markup containing color palette swatches</small>
                </div>
                
                <button type="button" class="btn" id="process-btn">Process Palette</button>
            </div>
            
            <div class="palette-display" id="palette-display" aria-label="Processed color palette preview">
                <p style="color: #666;">Your processed palette will appear here</p>
            </div>
            
            <div class="palette-actions">
                <button type="button" class="btn" id="download-btn" disabled>Download Enhanced SVG</button>
                <button type="button" class="btn" id="share-btn" disabled>Generate Share URL</button>
                <div id="share-url" style="word-break: break-all; font-family: monospace; font-size: 0.9em; width: 100%;"></div>
            </div>
        </section>
        
        <aside class="controls">
            <h2 style="padding: 1rem; margin: 0; background: #e9ecef; border-radius: 4px 4px 0 0;">Swatch Configuration</h2>
            <div class="controls-grid" id="swatch-controls">
                <p style="grid-column: 1 / -1; text-align: center; color: #666; margin: 2rem;">Process a palette to configure swatches</p>
            </div>
        </aside>
    </main>

    <footer class="footer">
        <h3>How to Use This Tool</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
            <div>
                <h4>Getting Started</h4>
                <ol>
                    <li>Upload an SVG file or paste SVG code containing color swatches</li>
                    <li>Click "Process Palette" to extract and analyze colors</li>
                    <li>Configure each swatch with meaningful names and categories</li>
                    <li>Download the enhanced SVG or share via URL</li>
                </ol>
            </div>
            
            <div>
                <h4>Design System Applications</h4>
                <ul>
                    <li><strong>Component Libraries:</strong> Standardized color tokens with semantic naming</li>
                    <li><strong>Documentation:</strong> Auto-generated color specs with multiple formats</li>
                    <li><strong>CSS Variables:</strong> Export data attributes as custom properties</li>
                    <li><strong>Design Tools:</strong> Import enhanced palettes into Figma, Sketch, etc.</li>
                </ul>
            </div>
            
            <div>
                <h4>Code Example</h4>
                <p>Enhanced SVG elements include comprehensive color data:</p>
                <pre><code>&lt;rect id="primary-500" 
      data-color-hex="#3b82f6"
      data-color-rgb="rgb(59, 130, 246)"
      data-color-hsl="hsl(217, 91%, 60%)"
      data-color-oklch="oklch(0.63 0.17 264)"
      data-color-lab="lab(63.02 8.21 -58.42)"
      data-color-name="Primary Blue"
      data-color-category="primary"
      fill="#3b82f6" /&gt;</code></pre>
            </div>
            
            <div>
                <h4>JavaScript Usage</h4>
                <pre><code>// Extract color data from enhanced SVG
const colorData = Array.from(
  document.querySelectorAll('[data-color-hex]')
).map(el => ({
  id: el.id,
  name: el.dataset.colorName,
  category: el.dataset.colorCategory,
  hex: el.dataset.colorHex,
  oklch: el.dataset.colorOklch
}));</code></pre>
            </div>
        </div>
    </footer>

    <dialog id="category-tooltip" class="tooltip-dialog">
        <h4>Color Category Examples</h4>
        <p><strong>FYI:</strong> Categories help organize colors in design systems and component libraries.</p>
        <ul>
            <li><strong>primary:</strong> Main brand colors, primary actions</li>
            <li><strong>secondary:</strong> Supporting brand colors, secondary actions</li>
            <li><strong>accent:</strong> Highlight colors, call-to-action elements</li>
            <li><strong>neutral:</strong> Grays, backgrounds, borders, text</li>
            <li><strong>semantic:</strong> Success, warning, error, info states</li>
            <li><strong>surface:</strong> Card backgrounds, overlays, containers</li>
            <li><strong>interactive:</strong> Links, buttons, form controls</li>
            <li><strong>decorative:</strong> Illustrations, graphics, visual elements</li>
        </ul>
        <button type="button" class="btn" onclick="document.getElementById('category-tooltip').close()">Close</button>
    </dialog>

    <script>
        // State management
        var currentPalette = null;
        var swatchData = [];

        // DOM references
        var elements = {
            fileInput: document.getElementById('file-input'),
            svgInput: document.getElementById('svg-input'),
            processBtn: document.getElementById('process-btn'),
            paletteDisplay: document.getElementById('palette-display'),
            downloadBtn: document.getElementById('download-btn'),
            shareBtn: document.getElementById('share-btn'),
            shareUrl: document.getElementById('share-url'),
            swatchControls: document.getElementById('swatch-controls')
        };

        // Utility functions
        function extractColorFromElement(element) {
            return element.getAttribute('fill') || 
                   element.getAttribute('color') || 
                   element.style.fill || 
                   element.style.color || 
                   '#000000';
        }

        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                var d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
        }

        function rgbToOklch(r, g, b) {
            // Simple approximation for OKLCH
            var hsl = rgbToHsl(r, g, b);
            return {
                l: hsl.l / 100,
                c: hsl.s / 100 * 0.4,
                h: hsl.h
            };
        }

        function rgbToLab(r, g, b) {
            // Simple approximation for LAB
            var hsl = rgbToHsl(r, g, b);
            return {
                l: hsl.l,
                a: (hsl.h > 180 ? hsl.h - 360 : hsl.h) * hsl.s / 100,
                b: Math.sin(hsl.h * Math.PI / 180) * hsl.s
            };
        }

        function getColorData(hex) {
            var rgb = hexToRgb(hex);
            if (!rgb) return {};
            
            var hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
            var oklch = rgbToOklch(rgb.r, rgb.g, rgb.b);
            var lab = rgbToLab(rgb.r, rgb.g, rgb.b);
            
            return {
                hex: hex,
                rgb: 'rgb(' + rgb.r + ', ' + rgb.g + ', ' + rgb.b + ')',
                hsl: 'hsl(' + hsl.h + ', ' + hsl.s + '%, ' + hsl.l + '%)',
                oklch: 'oklch(' + oklch.l.toFixed(2) + ' ' + oklch.c.toFixed(2) + ' ' + oklch.h + ')',
                lab: 'lab(' + lab.l.toFixed(2) + ' ' + lab.a.toFixed(2) + ' ' + lab.b.toFixed(2) + ')'
            };
        }

        // SVG processing functions
        function processSVG(svgString) {
            try {
                var parser = new DOMParser();
                var doc = parser.parseFromString(svgString, 'image/svg+xml');
                var svg = doc.documentElement;

                if (svg.nodeName !== 'svg') {
                    throw new Error('Invalid SVG format');
                }

                var colorElements = svg.querySelectorAll('[fill]:not([fill="none"]), [color], [style*="fill:"]');
                var colors = [];
                var colorIndex = 1;

                for (var i = 0; i < colorElements.length; i++) {
                    var el = colorElements[i];
                    var color = extractColorFromElement(el);
                    if (color && color !== 'none') {
                        // Skip white colors (various representations)
                        var normalizedColor = color.toLowerCase();
                        if (normalizedColor === '#ffffff' || 
                            normalizedColor === '#fff' || 
                            normalizedColor === 'white' ||
                            normalizedColor === 'rgb(255,255,255)' ||
                            normalizedColor === 'rgb(255, 255, 255)') {
                            continue;
                        }
                        
                        var colorData = getColorData(color);
                        colors.push({
                            element: el,
                            color: color,
                            index: i,
                            id: 'color-' + colorIndex,
                            name: 'Color ' + colorIndex,
                            hex: colorData.hex,
                            rgb: colorData.rgb,
                            hsl: colorData.hsl,
                            oklch: colorData.oklch,
                            lab: colorData.lab
                        });
                        colorIndex++;
                    }
                }

                return { svg: svg, colors: colors };
            } catch (error) {
                throw new Error('SVG processing failed: ' + error.message);
            }
        }

        function enhanceSVG(originalSvg, swatchData) {
            var svg = originalSvg.cloneNode(true);
            var colorElements = svg.querySelectorAll('[fill]:not([fill="none"]), [color], [style*="fill:"]');
            
            for (var i = 0; i < swatchData.length && i < colorElements.length; i++) {
                var element = colorElements[i];
                var swatch = swatchData[i];
                
                element.id = swatch.id || 'color-' + i;
                element.setAttribute('data-color-hex', swatch.hex);
                element.setAttribute('data-color-rgb', swatch.rgb);
                element.setAttribute('data-color-hsl', swatch.hsl);
                element.setAttribute('data-color-oklch', swatch.oklch);
                element.setAttribute('data-color-lab', swatch.lab);
                element.setAttribute('data-color-name', swatch.name || 'Color ' + (i + 1));
                
                if (swatch.category) {
                    element.setAttribute('data-color-category', swatch.category);
                }
            }

            return svg;
        }

        // UI update functions
        function updatePaletteDisplay() {
            if (!currentPalette) return;

            var enhanced = enhanceSVG(currentPalette.svg, swatchData);
            elements.paletteDisplay.innerHTML = '';
            elements.paletteDisplay.appendChild(enhanced);
        }

        function updateSwatchControls() {
            if (!swatchData.length) {
                elements.swatchControls.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666; margin: 2rem;">Process a palette to configure swatches</p>';
                return;
            }

            elements.swatchControls.innerHTML = '';
            
            for (var i = 0; i < swatchData.length; i++) {
                var swatch = swatchData[i];
                var container = document.createElement('div');
                container.className = 'swatch-editor';
                
                // Create color row
                var colorRow = document.createElement('div');
                colorRow.className = 'color-row';
                
                var colorPreview = document.createElement('div');
                colorPreview.className = 'color-preview';
                colorPreview.style.backgroundColor = swatch.color;
                
                var colorInfo = document.createElement('div');
                var colorHex = document.createElement('div');
                colorHex.style.fontWeight = 'bold';
                colorHex.style.fontSize = '0.9rem';
                colorHex.textContent = swatch.color;
                
                var colorHsl = document.createElement('div');
                colorHsl.className = 'color-info';
                colorHsl.textContent = swatch.hsl;
                
                colorInfo.appendChild(colorHex);
                colorInfo.appendChild(colorHsl);
                colorRow.appendChild(colorPreview);
                colorRow.appendChild(colorInfo);
                
                // Create input groups
                container.appendChild(colorRow);
                container.appendChild(createInputGroup('ID', 'id-' + i, swatch.id || '', i, 'id'));
                container.appendChild(createInputGroup('Name', 'name-' + i, swatch.name || '', i, 'name'));
                container.appendChild(createCategoryInputGroup('Category', 'category-' + i, swatch.category || '', i, 'category'));
                
                elements.swatchControls.appendChild(container);
            }
        }

        function createInputGroup(labelText, inputId, value, index, field) {
            var group = document.createElement('div');
            group.className = 'input-group';
            
            var label = document.createElement('label');
            label.setAttribute('for', inputId);
            label.textContent = labelText;
            
            var input = document.createElement('input');
            input.type = 'text';
            input.id = inputId;
            input.value = value;
            input.dataset.index = index;
            input.dataset.field = field;
            input.addEventListener('input', handleSwatchInput);
            
            group.appendChild(label);
            group.appendChild(input);
            return group;
        }

        function createCategoryInputGroup(labelText, inputId, value, index, field) {
            var group = document.createElement('div');
            group.className = 'input-group';
            
            var label = document.createElement('label');
            label.setAttribute('for', inputId);
            label.textContent = labelText;
            
            var wrapper = document.createElement('div');
            wrapper.className = 'category-input-wrapper';
            
            var input = document.createElement('input');
            input.type = 'text';
            input.id = inputId;
            input.value = value;
            input.dataset.index = index;
            input.dataset.field = field;
            input.placeholder = 'e.g., primary';
            input.addEventListener('input', handleSwatchInput);
            
            var helpButton = document.createElement('button');
            helpButton.type = 'button';
            helpButton.className = 'btn btn-help';
            helpButton.setAttribute('aria-label', 'Show category examples');
            helpButton.textContent = '?';
            helpButton.addEventListener('click', function() {
                document.getElementById('category-tooltip').showModal();
            });
            
            wrapper.appendChild(input);
            wrapper.appendChild(helpButton);
            group.appendChild(label);
            group.appendChild(wrapper);
            return group;
        }
        
        function handleSwatchInput(e) {
            var target = e.target;
            var index = parseInt(target.dataset.index);
            var field = target.dataset.field;
            
            if (swatchData[index] && field) {
                swatchData[index][field] = target.value;
                updatePaletteDisplay();
            }
        }

        // File and input handlers
        function handleFile(file) {
            if (!file.type.includes('svg')) {
                alert('Please select an SVG file');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                elements.svgInput.value = e.target.result;
                processCurrentInput();
            };
            reader.readAsText(file);
        }

        function processCurrentInput() {
            var svgContent = elements.svgInput.value.trim();
            if (!svgContent) {
                alert('Please provide SVG content');
                return;
            }

            try {
                var result = processSVG(svgContent);
                currentPalette = result;
                swatchData = result.colors;
                
                updatePaletteDisplay();
                updateSwatchControls();
                
                elements.downloadBtn.disabled = false;
                elements.shareBtn.disabled = false;
                
                console.log('Processed ' + swatchData.length + ' colors');
            } catch (error) {
                alert(error.message);
                console.error(error);
            }
        }

        function downloadSVG() {
            if (!currentPalette) return;

            var enhanced = enhanceSVG(currentPalette.svg, swatchData);
            var svgString = new XMLSerializer().serializeToString(enhanced);
            
            var blob = new Blob([svgString], { type: 'image/svg+xml' });
            var url = URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = 'enhanced-palette.svg';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function generateShareURL() {
            if (!currentPalette) return;

            var shareData = {
                svg: new XMLSerializer().serializeToString(currentPalette.svg),
                swatches: swatchData
            };
            
            var encoded = btoa(JSON.stringify(shareData));
            var shareURL = window.location.origin + window.location.pathname + '?data=' + encoded;
            
            elements.shareUrl.innerHTML = '<p>Share URL:</p><div style="background: #f0f0f0; padding: 0.5rem; border-radius: 2px;">' + shareURL + '</div>';
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareURL).then(function() {
                    alert('Share URL copied to clipboard!');
                }).catch(function() {
                    console.log('Could not copy to clipboard');
                });
            }
        }

        // Load from URL
        function loadFromURL() {
            var params = new URLSearchParams(window.location.search);
            var data = params.get('data');
            
            if (data) {
                try {
                    var decoded = JSON.parse(atob(data));
                    elements.svgInput.value = decoded.svg;
                    processCurrentInput();
                    
                    if (decoded.swatches) {
                        swatchData = decoded.swatches;
                        updateSwatchControls();
                        updatePaletteDisplay();
                    }
                } catch (error) {
                    console.error('Failed to load shared data:', error);
                }
            }
        }

        // Event listeners
        elements.fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) handleFile(file);
        });

        elements.processBtn.addEventListener('click', processCurrentInput);
        elements.downloadBtn.addEventListener('click', downloadSVG);
        elements.shareBtn.addEventListener('click', generateShareURL);

        // Drag and drop
        elements.paletteDisplay.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        elements.paletteDisplay.addEventListener('drop', function(e) {
            e.preventDefault();
            var files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        // Initialize
        loadFromURL();
    </script>
</body>
</html>